import streamlit as st
import pandas as pd
import time
from datetime import datetime

# 1. í˜ì´ì§€ ì„¤ì • (ì™€ì´ë“œ ëª¨ë“œ)
st.set_page_config(page_title="WOORI STEEL ì˜ì—…ê´€ë¦¬ ì‹œìŠ¤í…œ", layout="wide", initial_sidebar_state="expanded")

# 2. ìŠ¤íƒ€ì¼ ì„¤ì • (ì—…ë¬´ìš© ëŒ€ì‹œë³´ë“œ ëŠë‚Œ)
st.markdown("""
    <style>
    .stApp { background-color: #1E1E1E; color: #FFFFFF; }
    [data-testid="stSidebar"] { background-color: #2B2B2B; border-right: 1px solid #444; }
    h1, h2, h3 { color: #D4AF37 !important; }
    .stDataFrame { border: 1px solid #444; }
    /* ë©”ë‰´ í™œì„±í™” ìŠ¤íƒ€ì¼ */
    .stButton button { width: 100%; text-align: left; border-radius: 5px; }
    </style>
    """, unsafe_allow_html=True)

# ==========================================
# [ë¡œê·¸ì¸ í™”ë©´] ë³´ì•ˆ í•„ìˆ˜
# ==========================================
if 'logged_in' not in st.session_state:
    st.session_state['logged_in'] = False

if not st.session_state['logged_in']:
    st.title("ğŸ”’ WOORI STEEL ì˜ì—…ê´€ë¦¬ ì ‘ì†")
    col1, col2 = st.columns([1, 2])
    with col1:
        pw = st.text_input("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
        if st.button("ë¡œê·¸ì¸"):
            if pw == "0723": # ê´€ë¦¬ì ë¹„ë²ˆ
                st.session_state['logged_in'] = True
                st.rerun()
            else:
                st.error("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.")
    st.stop() # ë¡œê·¸ì¸ ì „ì—ëŠ” ì•„ë˜ ì½”ë“œ ì‹¤í–‰ ì•ˆ í•¨


# ==========================================
# [ì‚¬ì´ë“œë°”] ERP ë©”ë‰´ êµ¬ì„± (ëŒ€í‘œë‹˜ ë¡œë“œë§µ)
# ==========================================
with st.sidebar:
    st.title("WOORI STEEL\nManager System")
    st.markdown("---")
    menu = st.radio("ì—…ë¬´ ì„ íƒ", [
        "1. ìˆ˜ì£¼/ë°œì£¼ ê´€ë¦¬ (AI)", 
        "2. ìƒì‚° ê´€ë¦¬", 
        "3. ì¬ê³  ê´€ë¦¬", 
        "4. ì¶œê³ /ë°°ì°¨ ê´€ë¦¬",
        "5. ìˆ˜ê¸ˆ/ë¯¸ìˆ˜ ê´€ë¦¬"
    ])
    st.markdown("---")
    st.info(f"ì ‘ì†ì: ê´€ë¦¬ì\në‚ ì§œ: {datetime.now().strftime('%Y-%m-%d')}")
    if st.button("ë¡œê·¸ì•„ì›ƒ"):
        st.session_state['logged_in'] = False
        st.rerun()

# ==========================================
# [ë‚´ë¶€ ë¡œì§] ë‹¨ê°€ ê³„ì‚°ê¸° (AIê°€ ì‚¬ìš©í•  ë‘ë‡Œ)
# ==========================================
def calculate_price(mat, kind, thick, grade_or_density):
    # (ê¸°ì¡´ ë‹¨ê°€í‘œ ë¡œì§ì„ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜´ - 50T ê¸°ì¤€ê°’)
    base_eps, base_gw, base_ure = 11500, 13800, 24500
    gap_eps, gap_gw, gap_ure = 800, 2400, 4000
    
    price = 0
    # ê°„ë‹¨ ì˜ˆì‹œ ë¡œì§ (ì‹¤ì œë¡œëŠ” ì •êµí•œ ë¡œì§ ì ìš©)
    if mat == "EPS": price = base_eps + (int(thick/25)*gap_eps)
    elif mat == "GW": price = base_gw + (int(thick/25)*gap_gw)
    elif mat == "URE": price = base_ure + (int(thick/25)*gap_ure)
    
    return price

# ==========================================
# [ë©”ì¸ í™”ë©´] ë©”ë‰´ë³„ ê¸°ëŠ¥
# ==========================================

# ----------------------------------------------------
# 1. ìˆ˜ì£¼/ë°œì£¼ ê´€ë¦¬ (AI í•µì‹¬ ê¸°ëŠ¥)
# ----------------------------------------------------
if menu == "1. ìˆ˜ì£¼/ë°œì£¼ ê´€ë¦¬ (AI)":
    st.header("ğŸ“ AI ìˆ˜ì£¼ ë“±ë¡ ë° ë³€í™˜")
    st.markdown("ê³ ê°ì´ ë³´ë‚¸ **ì£¼ë¬¸ì„œ(ì´ë¯¸ì§€, ì—‘ì…€, ì¹´í†¡)**ë¥¼ ì—…ë¡œë“œí•˜ë©´ **ì´ì¹´ìš´íŠ¸ ì—…ë¡œë“œìš© ì—‘ì…€**ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.")
    
    c1, c2 = st.columns([1, 2])
    
    with c1: # ì…ë ¥ì°½
        st.subheader("1. ì£¼ë¬¸ ì ‘ìˆ˜")
        client_name = st.text_input("ê±°ë˜ì²˜ëª…", "ì£¼ì‹íšŒì‚¬ ëŒ€ì„±í”ŒëŸ¬ìŠ¤")
        site_name = st.text_input("í˜„ì¥ëª…", "íœ´ì˜¨ìŠ¤ì•¤ ì¶˜ì²œê³µì¥")
        
        uploaded_file = st.file_uploader("ì£¼ë¬¸ì„œ íŒŒì¼ ì—…ë¡œë“œ", type=['png', 'jpg', 'xlsx', 'pdf'])
        raw_text = st.text_area("ë˜ëŠ” í…ìŠ¤íŠ¸ ì§ì ‘ ì…ë ¥", height=150, placeholder="ì˜ˆ: GW 125T 48K ë²½ì²´, 3.5m 10ì¥, ë¶€ìì¬ ë¬¼ë°›ì´ 20ê°œ...")
        
        btn_analyze = st.button("ğŸš€ AI ë¶„ì„ ì‹¤í–‰", type="primary")

    with c2: # ê²°ê³¼ì°½
        st.subheader("2. ë³€í™˜ ê²°ê³¼ í™•ì¸ (ìˆ˜ì • ê°€ëŠ¥)")
        
        if btn_analyze:
            with st.spinner("AIê°€ ì£¼ë¬¸ì„œë¥¼ ë¶„ì„í•˜ê³  ë‹¨ê°€ë¥¼ ë§¤ì¹­ ì¤‘ì…ë‹ˆë‹¤..."):
                time.sleep(1.5) # ë¶„ì„ ì‹œë®¬ë ˆì´ì…˜
                
                # --- [AI ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°] ---
                # AIê°€ 'GW', '125T'ë¥¼ ë³´ê³  ë‹¨ê°€í‘œ ë¡œì§ì„ ëŒë ¤ì„œ ë‹¨ê°€ê¹Œì§€ ê°€ì ¸ì™”ë‹¤ê³  ê°€ì •
                data = {
                    'í’ˆëª©ì½”ë“œ(ERP)': ['GW-WALL-125-48', 'GW-WALL-125-48', 'SUB-GUTTER', 'SUB-SCREW-IV'],
                    'í’ˆëª©ëª…': ['GWíŒë„¬ ë²½ì²´ 125T (48K)', 'GWíŒë„¬ ë²½ì²´ 125T (48K)', 'ì„ í™ˆí†µ (Gutter)', 'ìŠ¤í¬ë¥˜ë³¼íŠ¸ (ì•„ì´ë³´ë¦¬)'],
                    'ê·œê²©(ê¸¸ì´)': [2.900, 3.170, 3.000, 0],
                    'ìˆ˜ëŸ‰': [6, 5, 20, 1000],
                    'ë‹¨ê°€(AIì¶”ì²œ)': [25500, 25500, 12000, 50], # ë‹¨ê°€ ìë™ ê³„ì‚°ë¨
                    'ë¹„ê³ ': ['', '', 'ë¬¼ë°›ì´', '']
                }
                df = pd.DataFrame(data)
                # ---------------------------
                
                st.success(f"âœ… ë¶„ì„ ì™„ë£Œ! ì´ {len(df)}ê°œ í’ˆëª©ì´ ì‹ë³„ë˜ì—ˆìŠµë‹ˆë‹¤.")
                
                # ë°ì´í„° ì—ë””í„° (ì§ì›ì´ ìˆ˜ì •)
                edited_df = st.data_editor(
                    df,
                    num_rows="dynamic",
                    use_container_width=True,
                    height=400
                )
                
                # í•©ê³„ ê¸ˆì•¡ ê³„ì‚°
                total_amt = (edited_df['ìˆ˜ëŸ‰'] * edited_df['ë‹¨ê°€(AIì¶”ì²œ)']).sum()
                st.metric(label="ì´ ê³µê¸‰ê°€ì•¡ (ì˜ˆìƒ)", value=f"{total_amt:,.0f}ì›")
                
                # ì´ì¹´ìš´íŠ¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                csv = edited_df.to_csv(index=False).encode('utf-8-sig')
                st.download_button(
                    label="ğŸ’¾ ì´ì¹´ìš´íŠ¸(Webìë£Œì˜¬ë¦¬ê¸°) ì—‘ì…€ ë‹¤ìš´ë¡œë“œ",
                    data=csv,
                    file_name=f"ìˆ˜ì£¼ì„œ_{client_name}_{datetime.now().strftime('%Y%m%d')}.csv",
                    mime='text/csv'
                )

# ----------------------------------------------------
# 2. ìƒì‚° ê´€ë¦¬ (Mockup)
# ----------------------------------------------------
elif menu == "2. ìƒì‚° ê´€ë¦¬":
    st.header("ğŸ­ ìƒì‚° ì§€ì‹œ ë° í˜„í™©")
    st.info("ì´ì¹´ìš´íŠ¸ì˜ [ìƒì‚°ì§€ì‹œì„œ] ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ê³µì¥ ëª¨ë‹ˆí„°ì— ë„ìš°ëŠ” í™”ë©´ì…ë‹ˆë‹¤.")
    
    # ê°€ìƒì˜ ìƒì‚° ëŒ€ê¸°ì—´
    prod_data = pd.DataFrame({
        'ì§€ì‹œì¼ì': ['2026-02-11', '2026-02-11'],
        'í˜„ì¥ëª…': ['íœ´ì˜¨ìŠ¤ì•¤ ì¶˜ì²œê³µì¥', 'ì‚¼ì„±ì „ì í‰íƒìº í¼ìŠ¤'],
        'í’ˆëª©': ['GW 125T ë²½ì²´', 'EPS 100T ì§€ë¶•'],
        'ì´ìˆ˜ëŸ‰(m)': [1500, 3000],
        'ì§„í–‰ìƒíƒœ': ['ìƒì‚°ì¤‘ (80%)', 'ëŒ€ê¸°']
    })
    st.dataframe(prod_data, use_container_width=True)

# ----------------------------------------------------
# 3. ì¬ê³  ê´€ë¦¬ (Mockup)
# ----------------------------------------------------
elif menu == "3. ì¬ê³  ê´€ë¦¬":
    st.header("ğŸ“¦ ì½”ì¼ ë° ë¶€ìì¬ ì¬ê³ ")
    col1, col2 = st.columns(2)
    with col1:
        st.write("##### ì½”ì¼ ì¬ê³  í˜„í™©")
        st.bar_chart({'ì•„ì´ë³´ë¦¬': 50, 'ì€íšŒìƒ‰': 30, 'ì§•í¬ë¸”ë™': 20})
    with col2:
        st.write("##### ì£¼ìš” ë¶€ìì¬ ì¬ê³  (ë¶€ì¡± ì•Œë¦¼)")
        st.error("âš ï¸ ìŠ¤í¬ë¥˜ë³¼íŠ¸ 150mm ì¬ê³  ë¶€ì¡± (í˜„ì¬ 2ë°•ìŠ¤)")

# ----------------------------------------------------
# 4. ì¶œê³ /ë°°ì°¨ ê´€ë¦¬ (Mockup)
# ----------------------------------------------------
elif menu == "4. ì¶œê³ /ë°°ì°¨ ê´€ë¦¬":
    st.header("ğŸšš ë°°ì°¨ ë° ì¶œê³ ì¦ ë°œí–‰")
    st.write("ê¸ˆì¼ ì¶œê³  ì˜ˆì • ë¦¬ìŠ¤íŠ¸")
    st.checkbox("íœ´ì˜¨ìŠ¤ì•¤ ì¶˜ì²œê³µì¥ - 5í†¤ ì¶•ì°¨ (ê²½ê¸°88ë°” 1234) - 14:00 ìƒì°¨ ì˜ˆì •")

# ----------------------------------------------------
# 5. ìˆ˜ê¸ˆ/ë¯¸ìˆ˜ ê´€ë¦¬ (Mockup)
# ----------------------------------------------------
elif menu == "5. ìˆ˜ê¸ˆ/ë¯¸ìˆ˜ ê´€ë¦¬":
    st.header("ğŸ’° ë¯¸ìˆ˜ê¸ˆ í˜„í™©")
    st.warning("ì¥ê¸° ë¯¸ìˆ˜ ê±°ë˜ì²˜: (ì£¼)OOê±´ì„¤ - 3ê°œì›” ê²½ê³¼")
    st.dataframe(pd.DataFrame({
        'ê±°ë˜ì²˜': ['ëŒ€ì„±í”ŒëŸ¬ìŠ¤', 'OOê±´ì„¤'],
        'ë¯¸ìˆ˜ê¸ˆì•¡': [20500000, 5500000],
        'ìµœê·¼ìˆ˜ê¸ˆì¼': ['2026-01-30', '2025-11-20']
    }), use_container_width=True)